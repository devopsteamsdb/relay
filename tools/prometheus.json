{
    "name": "Prometheus",
    "description": "Monitoring and alerting toolkit",
    "download_steps": [
        {
            "type": "shell",
            "command": "PROM_VER=$(curl -s https://api.github.com/repos/prometheus/prometheus/releases/latest | grep tag_name | cut -d '\"' -f 4 | sed 's/v//') && curl -L https://github.com/prometheus/prometheus/releases/download/v$PROM_VER/prometheus-$PROM_VER.linux-amd64.tar.gz -o {download_dir}/prometheus.tar.gz"
        }
    ],
    "install_steps": [
        {
            "type": "shell",
            "command": "tar xvfz {download_dir}/prometheus.tar.gz -C /tmp/ --strip-components=1"
        },
        {
            "type": "shell",
            "command": "useradd --no-create-home --shell /bin/false prometheus || true"
        },
        {
            "type": "shell",
            "command": "mkdir -p /etc/prometheus /var/lib/prometheus"
        },
        {
            "type": "shell",
            "command": "cp /tmp/prometheus /usr/local/bin/"
        },
        {
            "type": "shell",
            "command": "cp /tmp/promtool /usr/local/bin/"
        },
        {
            "type": "shell",
            "command": "cp -r /tmp/consoles /etc/prometheus"
        },
        {
            "type": "shell",
            "command": "cp -r /tmp/console_libraries /etc/prometheus"
        },
        {
            "type": "shell",
            "command": "chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus /usr/local/bin/prometheus /usr/local/bin/promtool"
        },
        {
            "type": "shell",
            "command": "cat > /etc/prometheus/prometheus.yml <<EOF\nglobal:\n  scrape_interval: 15s\nscrape_configs:\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\nEOF"
        },
        {
            "type": "shell",
            "command": "cat > /etc/systemd/system/prometheus.service <<EOF\n[Unit]\nDescription=Prometheus\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=prometheus\nGroup=prometheus\nType=simple\nExecStart=/usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --storage.tsdb.path /var/lib/prometheus/ --web.console.templates=/etc/prometheus/consoles --web.console.libraries=/etc/prometheus/console_libraries\n\n[Install]\nWantedBy=multi-user.target\nEOF"
        },
        {
            "type": "shell",
            "command": "systemctl daemon-reload"
        },
        {
            "type": "shell",
            "command": "systemctl enable --now prometheus"
        }
    ],
    "idempotency_check": "systemctl is-active prometheus"
}